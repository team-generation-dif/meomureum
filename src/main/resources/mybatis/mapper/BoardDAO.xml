<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.meomureum.springboot.dao.IBoardDAO">
<select id="countTodayBoards" resultType="int">
    SELECT COUNT(*) FROM board 
    WHERE TRUNC(created_at) = TRUNC(SYSDATE)
</select>
	<select id="selectBestPosts" resultType="com.meomureum.springboot.dto.BoardDTO">
    <![CDATA[
    SELECT 
        b_code, 
        b_title, 
        b_content, 
        b_view, 
        b_category, 
        created_at, 
        m_code
    FROM (
        SELECT * FROM board 
        ORDER BY b_view DESC, b_code DESC
    ) 
    WHERE ROWNUM <= 4
    ]]>
</select>
    <!-- 게시판 목록 -->
    <select id="listDao" resultType="com.meomureum.springboot.dto.BoardDTO">
        SELECT b_code,
        b_title,
        b_content,
        b_view,
        b_category,
        created_at,
        m_code
        FROM board ORDER BY b_code DESC
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="selectDao" parameterType="String" resultType="com.meomureum.springboot.dto.BoardDTO">
    	SELECT b.b_code, b.b_title, b.b_content, b.b_view, b.b_category, b.created_at,
           	b.m_code, m.m_nick
    	FROM board b
    	JOIN member m ON b.m_code = m.m_code
    	WHERE b.b_code = #{b_code}
	</select>


    <!-- 게시글 등록 -->
    <insert id="insertDao" parameterType="com.meomureum.springboot.dto.BoardDTO">
    <selectKey keyProperty="b_code" resultType="String" order="BEFORE">
        SELECT 'B'||LPAD(board_seq.NEXTVAL, 5, '0') FROM dual
    </selectKey>
    INSERT INTO board (b_code, b_title, b_content, b_view, b_category, created_at, m_code)
    VALUES (#{b_code}, #{b_title}, #{b_content}, 0, #{b_category}, sysdate, #{m_code,jdbcType=VARCHAR})
	</insert>

    <!-- 게시글 삭제 -->
    <delete id="deleteDao" parameterType="String">
        DELETE FROM board WHERE b_code = #{b_code}
    </delete>
    
    <delete id="deleteBoard" parameterType="String">
    	DELETE FROM board WHERE b_code = #{b_code}
	</delete>
        
    <!-- 게시글 수정 -->
    <update id="updateDao" parameterType="com.meomureum.springboot.dto.BoardDTO">
        UPDATE board
        SET b_title = #{b_title},
            b_content = #{b_content},
            b_category = #{b_category}
        WHERE b_code = #{b_code}
    </update>

    <!-- 제목으로 조회 -->
    <select id="boardTitle" parameterType="String" resultType="com.meomureum.springboot.dto.BoardDTO">
        SELECT * FROM board WHERE b_title = #{b_title}
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="String">
        UPDATE board
        SET b_view = b_view + 1
        WHERE b_code = #{b_code}
    </update>
   <select id="getMyRecentPosts" parameterType="String" resultType="com.meomureum.springboot.dto.BoardDTO">
    <![CDATA[
    SELECT 
        b_code, b_title, b_content, b_view, b_category, created_at, m_code
    FROM (
        SELECT * FROM board 
        WHERE m_code = #{m_code, jdbcType=VARCHAR}
        ORDER BY created_at DESC
    ) 
    WHERE ROWNUM <= 3
    ]]>
</select>
</mapper>