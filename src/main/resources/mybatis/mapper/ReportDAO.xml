<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.meomureum.springboot.dao.IReportDAO">

    <insert id="insertReport" parameterType="com.meomureum.springboot.dto.ReportDTO">
        INSERT INTO report (
            rep_code, rep_category, m_code, rep_title, rep_content, target_code, rep_status, created_at
        ) VALUES (
            'REP' || LPAD(report_seq.NEXTVAL, 4, '0'),
            #{rep_category},
            #{m_code},
            #{rep_title},
            #{rep_content},
            #{target_code},
            'PENDING',        
            SYSDATE
        )
    </insert>
    
    <select id="listReports" resultType="com.meomureum.springboot.dto.ReportDTO">
        SELECT rep_code, rep_category, m_code, rep_title, rep_content, target_code, created_at, rep_status
        FROM report
        ORDER BY 
        CASE rep_status
            WHEN 'PENDING' THEN 1
            WHEN 'DONE' THEN 2
            WHEN 'IGNORE' THEN 3
        END,
        created_at DESC
    </select>
    
    <select id="listPendingReports" parameterType="map" resultType="com.meomureum.springboot.dto.ReportDTO">
        SELECT *
        FROM (
            SELECT ROWNUM AS rnum, A.*
            FROM (
                SELECT *
                FROM report
                WHERE (rep_status IS NULL OR rep_status = 'PENDING')
                <if test="keyword != null and keyword != ''">
                    AND (rep_title LIKE '%' || #{keyword} || '%' 
                     OR rep_content LIKE '%' || #{keyword} || '%')
                </if>
                ORDER BY rep_code DESC
            ) A
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE rnum &gt;= #{startRow}
    </select>

    <select id="countPendingReports" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE (rep_status IS NULL OR rep_status = 'PENDING')
        <if test="keyword != null and keyword != ''">
            AND (rep_title LIKE '%' || #{keyword} || '%' 
             OR rep_content LIKE '%' || #{keyword} || '%')
        </if>
    </select>

    <select id="listDoneReports" parameterType="map" resultType="com.meomureum.springboot.dto.ReportDTO">
        SELECT * FROM (
            SELECT ROWNUM AS rnum, A.*
            FROM (
                SELECT * FROM report
                WHERE rep_status = 'DONE'
                <if test="keyword != null and keyword != ''">
                    AND (rep_title LIKE '%' || #{keyword} || '%' OR rep_content LIKE '%' || #{keyword} || '%')
                </if>
                ORDER BY rep_code DESC
            ) A
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE rnum &gt;= #{startRow}
    </select>
    
    <select id="countDoneReports" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE rep_status = 'DONE'
        <if test="keyword != null and keyword != ''">
            AND (rep_title LIKE '%' || #{keyword} || '%' OR rep_content LIKE '%' || #{keyword} || '%')
        </if>
    </select>
    
    <select id="listIgnoredReports" parameterType="map" resultType="com.meomureum.springboot.dto.ReportDTO">
        SELECT * FROM (
            SELECT ROWNUM AS rnum, A.*
            FROM (
                SELECT * FROM report
                WHERE rep_status = 'IGNORE'
                <if test="keyword != null and keyword != ''">
                    AND (rep_title LIKE '%' || #{keyword} || '%' OR rep_content LIKE '%' || #{keyword} || '%')
                </if>
                ORDER BY rep_code DESC
            ) A
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE rnum &gt;= #{startRow}
    </select>

    <select id="countIgnoredReports" resultType="int">
        SELECT COUNT(*) FROM report
        WHERE rep_status = 'IGNORE'
    </select>
    
    <select id="findReportByCode" parameterType="String" resultType="com.meomureum.springboot.dto.ReportDTO">
        SELECT rep_code, rep_category, m_code, rep_title, rep_content, target_code, created_at, rep_status
        FROM report
        WHERE rep_code = #{rep_code}
    </select>
     
    <select id="countReportsByStatus" parameterType="String" resultType="int">
        SELECT COUNT(*) 
        FROM report 
        WHERE rep_status = #{status}
    </select>

    <select id="countAllReports" resultType="int">
        SELECT COUNT(*) FROM report
    </select>     
                                                                                                    
    <update id="updateReportStatus" parameterType="com.meomureum.springboot.dto.ReportDTO">
        UPDATE report
        SET rep_status = #{rep_status}
        WHERE rep_code = #{rep_code}
    </update>            
        
</mapper>