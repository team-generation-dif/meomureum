<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.meomureum.springboot.dao.IScheduleDAO">
	<select id="listDAOByMCode" resultType="com.meomureum.springboot.dto.ScheduleDTO">
		select * from schedule where m_code = #{m_code}	and s_end >= trunc(sysdate)
	</select>
	<select id="listDAOByCntPcode" resultType="com.meomureum.springboot.dto.PlaceDTO">
	    select * from (
	        select p.p_code, p.p_place, p.p_addr,
	               f.file_path, COUNT(r.p_code) as cnt from route r
	        	join place p on (r.p_code = p.p_code)
	        	join fileupload f on (p.p_code = f.target_code) 
	        	and f.target_type = 'PLACE' and f.file_order = 1
	        	where f.file_path is not null
	        	group by p.p_code, p.p_place, p.p_addr, f.file_path
	        	order by cnt DESC
	    )
	    WHERE ROWNUM <![CDATA[ <= ]]> 10
	</select>
	<select id="selectDAO" resultType="com.meomureum.springboot.dto.ScheduleDTO">
		select * from schedule where s_code = #{s_code}
	</select>
	<insert id="insertDAO">
		<selectKey keyProperty="s_code" resultType="string" order="BEFORE">
        	SELECT 'S'||lpad(schedule_seq.nextval,5,'0') FROM DUAL
    	</selectKey>
		insert into schedule
		 values(#{s_code},#{m_code,jdbcType=VARCHAR},sysdate,#{s_start},#{s_end},#{s_name},#{p_name})
	</insert>
	<delete id="deleteDAO">
		delete from schedule where s_code = #{s_code}
	</delete>
 	<update id="updateDAO"> 
		update schedule
		 set s_name = #{s_name}, 
		 s_start = TO_DATE(SUBSTR(#{s_start}, 1, 10), 'YYYY-MM-DD'), 
         s_end = TO_DATE(SUBSTR(#{s_end}, 1, 10), 'YYYY-MM-DD')
		 where s_code = #{s_code}
	</update>
</mapper>